<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="../src/start.js"></script>
    <script src="../dist/datahub-chart.js"></script>

    <link rel="stylesheet" href="../style/components.css" />
    <link rel="stylesheet" href="../style/dark-theme.css" />
    <style>
        .chart {
            width: 400px;
            background-color: #233541;
        }

        .chart-row {
            display: flex;
        }

    </style>
</head>

<body>
    <div class="chart">
        <div class="chart-row topAxis">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
        <div class="chart-row wind">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
        <div class="chart-row windDirection">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
        <div class="chart-row wave">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
        <div class="chart-row tide">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
        <div class="chart-row bottomAxis">
            <div class="historical"></div>
            <div class="forecast"></div>
        </div>
    </div>
    <div class="info">
        <div class="timestamp"></div>
    </div>
    
    <script>

    // generated data
    var historicalDataConfig = {
        layerCount: 1,
        count: 10,
        timeIncrement: 'minute', 
        min: 0, 
        max: 50
    }

    var foecastDataConfig = datahub.utils.mergeAll({}, historicalDataConfig, {
        layerCount: 1,
        count: 100,
        timeIncrement: 'hour'
    })

    var data = {
        historical: {
            wind: datahub.data.generateTimeSeriesSplit(historicalDataConfig),
            windDirection: datahub.data.generateTimeSeriesSplit(historicalDataConfig),
            wave: datahub.data.generateTimeSeriesSplit(historicalDataConfig),
            tide: datahub.data.generateTimeSeriesSplit(historicalDataConfig),
            bottomAxis: datahub.data.generateTimeSeriesSplit(historicalDataConfig),
            topAxis: datahub.data.generateTimeSeriesSplit(historicalDataConfig)
        },
        forecast: {
            wind: datahub.data.generateTimeSeriesSplit(foecastDataConfig),
            windDirection: datahub.data.generateTimeSeriesSplit(foecastDataConfig),
            wave: datahub.data.generateTimeSeriesSplit(foecastDataConfig),
            tide: datahub.data.generateTimeSeriesSplit(foecastDataConfig),
            bottomAxis: datahub.data.generateTimeSeriesSplit(foecastDataConfig),
            topAxis: datahub.data.generateTimeSeriesSplit(foecastDataConfig)
        }
    }

    // chart config
    var historicalChartConfig = {
        tickStep: 20,
        resolution: 'minute',
        axisXFormat: '%H:%M',
        domain: [0, 50],
        chartType: 'area',
        yTicks: 3,
        height: 80,
        hide: ['xTitle', 'yTitle', 'xAxis'], //['xTitle', 'yTitle', 'tooltip', 'xAxis', 'yAxis', 'shapes', 'xGrid', 'xTitle', 'yTitle']
        margin: { top: 10, right: 20, bottom: 10, left: 50 }
    }

    var forecastChartConfig = datahub.utils.mergeAll({}, historicalChartConfig, {
        xTicks: d3.utcHour.every(12),
        resolution: 'hour',
        hide: ['xAxis', 'yAxis', 'yTitle', 'xTitle'],
        margin: { top: 10, right: 20, bottom: 10, left: 0 }
    })

    var commonArrowsConfig = {
        hide: ['xAxis', 'yAxis', 'xTitle', 'yTitle', 'tooltipDot'],
        chartType: 'arrow',
        arrowSkip: 1,
        height: 20,
        margin: { top: 0, right: 20, bottom: 0, left: 50 }
    }

    var historicalArrowsConfig = datahub.utils.mergeAll({}, historicalChartConfig, commonArrowsConfig)

    var forecastArrowsConfig = datahub.utils.mergeAll({}, forecastChartConfig, commonArrowsConfig, {
        margin: { top: 0, right: 20, bottom: 0, left: 0 },
        arrowSkip: 6
    })

    var commonSingleAxis = {
        axisOnly: true,
        xAxisOnTop: true,
        hide: ['yAxis', 'yTitle', 'tooltip', 'tooltipDot'],
        height: 20,
        margin: { top: 20, right: 20, bottom: 0, left: 50 }
    }

    var historicalTopAxis = datahub.utils.mergeAll({}, historicalChartConfig, commonSingleAxis)
    var forecastTopAxis = datahub.utils.mergeAll({}, forecastChartConfig, commonSingleAxis, {
        margin: {top: 20, right: 20, bottom: 0, left: 0 }
    })
    var historicalBottomAxis = datahub.utils.mergeAll({}, historicalChartConfig, commonSingleAxis, {
        margin: {top: 0, right: 20, bottom: 20, left: 50 },
        xAxisOnTop: false
    })
    var forecastBottomAxis = datahub.utils.mergeAll({}, forecastChartConfig, commonSingleAxis, {
        margin: {top: 0, right: 20, bottom: 20, left: 0 },
        xAxisOnTop: false
    })

    var config = {
        historical: {
            wind: historicalChartConfig,
            windDirection: historicalArrowsConfig,
            wave: historicalChartConfig,
            tide: historicalChartConfig,
            bottomAxis: historicalBottomAxis,
            topAxis: historicalTopAxis
        },
        forecast: {
            wind: forecastChartConfig,
            windDirection: forecastArrowsConfig,
            wave: forecastChartConfig,
            tide: forecastChartConfig,
            bottomAxis: forecastBottomAxis,
            topAxis: forecastTopAxis
        }
    }

    // chart object
    var charts = {
        historical: {
            wind: null,
            windDirection: null,
            wave: null,
            tide: null,
            bottomAxis: null,
            topAxis: null
        },
        forecast: {
            wind: null,
            windDirection: null,
            wave: null,
            tide: null,
            bottomAxis: null,
            topAxis: null
        }
    }

    var now = new Date(data.historical.wind[0].data.slice(-1)[0].timestamp)

    // tooltip events
    function setTimeInfo(timestamp) {
        var formattedDate = d3.utcFormat('%c')(timestamp)
        document.querySelector('.info .timestamp').innerText = formattedDate
    }

    function setTooltipsToActual() {
        var timestamp = now
        setTooltip('historical', null, now)

        setTimeInfo(timestamp)
    }

    function setTooltip(groupKey, chartKey, timestamp) {
        for(var x in charts) {
            if(x === groupKey) {
                for(var y in charts[x]) {
                    if(y !== chartKey) {
                        charts[x][y].setConfig({tooltipTimestamp: timestamp})
                    }
                }
            }
            else {
                for(var y in charts[x]) {
                    charts[x][y].setConfig({tooltipTimestamp: null})
                }
            }
        }

        setTimeInfo(timestamp)
    }

    // generate charts
    function setCharts() {
        for(var x in charts) {
            for(var y in charts[x]) {
                charts[x][y] = datahub.timeseries({
                        parent: document.querySelector('.' + y + ' .' + x)
                    })
                    .setConfig(config[x][y])
                    .setData(data[x][y])
                    .on('hover', (function(d) {
                        var groupKey = x
                        var chartKey = y
                        return function(d){
                            setTooltip(groupKey, chartKey, d[0].timestamp)
                        }
                    })())
                    .on('mouseout', setTooltipsToActual)
            }
        }
    }

    setCharts()

    </script>
</body>

</html>
